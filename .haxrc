# Custom docker volume mounts
# Uncomment to add additional volume mounts
# Separate with spaces
#HAXTOOLS_USER_VOLUMES=(--volume=~/CTFs:/home/hax/CTFs)

# Docker container UID
# Default is your current users UID
# If you change this you will need to delete the $HAXTOOLS_HOME/.antigen directory if it exists
LOCAL_USER_ID=$(id -u)

# Host system directories
# There should be no need to change these.
# Don't forget to update your shells RC file if you change the location of $HAXTOOLS_DIR
HAXTOOLS_HOME=$HAXTOOLS_DIR/home
HAXRC=$HAXTOOLS_DIR/.haxrc

### Here be dragons ###
for f in $HAXTOOLS_DIR/.tools/.cmd_*; do
  . "$f"
done

haxtools(){
  if [[ $LOCAL_USER_ID -gt 0 ]]; then
    HAXTOOLS_VOLUMES=(
    $HAXTOOLS_USER_VOLUMES
    --volume=$HAXTOOLS_HOME:/home/hax
    --volume=/tmp/.X11-unix:/tmp/.X11-unix:rw
    --volume=/dev/shm:/dev/shm
    )
  else
    HAXTOOLS_VOLUMES=(
    $HAXTOOLS_USER_VOLUMES
    --volume=$HAXTOOLS_HOME:/root
    --volume=/tmp/.X11-unix:/tmp/.X11-unix:rw
    --volume=/dev/shm:/dev/shm
    )
  fi
  haxtools_name="haxtools$n"
  launched=0
  while [[ "$launched" == 0 ]]; do
    if docker ps --format "{{.Names}}" | grep $haxtools_name >/dev/null 2>&1; then
      ((n=n+1))
      haxtools_name="haxtools$n"
    else
      launched=1
    fi
  done
  xhost + local:haxtools &> /dev/null
  docker run -it --rm \
  -e DISPLAY=unix$DISPLAY \
  ${HAXTOOLS_VOLUMES} \
  --env LOCAL_USER_ID=$LOCAL_USER_ID \
  --privileged \
  --cap-add=NET_ADMIN \
  --cap-add=NET_BROADCAST \
  --net=host \
  --hostname=haxtools \
  --name $haxtools_name infosux/haxtools:full "$@"
}

haxtools-update(){
  haxtools zsh -ic "antigen update"
  #git -C $HAXTOOLS_DIR stash
  #git -C $HAXTOOLS_DIR pull
  #git -C $HAXTOOLS_DIR stash pop
  git -C $HAXTOOLS_HOME/.tmux pull https://github.com/gpakosz/.tmux
  git clone https://github.com/1ndianl33t/Gf-Patterns /tmp/gf-patterns
  \cp /tmp/gf-patterns/*.json $HAXTOOLS_HOME/.gf/
  rm -rf /tmp/gf-patterns
  git clone https://github.com/tomnomnom/gf /tmp/gf
  \cp /tmp/gf/gf-completion.bash $HAXTOOLS_HOME/.gf/
  \cp /tmp/gf/gf-completion.zsh $HAXTOOLS_HOME/.gf/
  \cp /tmp/gf/examples/*.json $HAXTOOLS_HOME/.gf/
  rm -rf /tmp/gf
  docker pull infosux/haxtools:full
  docker system prune -f
  source $HAXRC
}

hax(){
  case "$1" in
    'update'|'-up'|'--update')
      haxtools-update
      ;;
    '--user'|'-u')
      LOCAL_USER_ID=$2
      haxtools "${@:3}"
      ;;
    'tmux')
      if [[ "$#" == 1 ]]; then
        haxtools zsh -ic 'sleep 0.5; tmux new -s hax; zsh'
      else
        haxtools zsh -ic "sleep 0.5; tmux new -s hax '"${@:2}"'; zsh"
      fi
      ;;
    *)
      haxtools "$@"
      ;;
  esac
}
